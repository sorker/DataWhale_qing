{
  "cells": [
    {
      "cell_type": "markdown",
      "source": [
        "# 预测视频文件\n",
        "\n",
        "使用训练好的图像分类模型，对视频文件进行逐帧预测。\n",
        "\n",
        "同济子豪兄：https://space.bilibili.com/1900783\n",
        "\n",
        "[代码运行云GPU环境](https://featurize.cn/?s=d7ce99f842414bfcaea5662a97581bd1)：GPU RTX 3060、CUDA v11.2"
      ],
      "metadata": {},
      "id": "4a36abc9-47b6-4e9a-8d2c-330e64012db2"
    },
    {
      "cell_type": "markdown",
      "source": [
        "## 设置Matplotlib中文字体"
      ],
      "metadata": {},
      "id": "2ceedcfc-5eef-4cd2-8374-885c6bced617"
    },
    {
      "cell_type": "code",
      "source": [
        "# # windows操作系统\n",
        "# plt.rcParams['font.sans-serif']=['SimHei']  # 用来正常显示中文标签 \n",
        "# plt.rcParams['axes.unicode_minus']=False  # 用来正常显示负号"
      ],
      "outputs": [],
      "execution_count": null,
      "metadata": {},
      "id": "7874c4db-e985-4dd2-aa5e-a711f8b83e24"
    },
    {
      "cell_type": "code",
      "source": [
        "# Mac操作系统，参考 https://www.ngui.cc/51cto/show-727683.html\n",
        "# 下载 simhei.ttf 字体文件\n",
        "# !wget https://zihao-openmmlab.obs.cn-east-3.myhuaweicloud.com/20220716-mmclassification/dataset/SimHei.ttf"
      ],
      "outputs": [],
      "execution_count": null,
      "metadata": {},
      "id": "1253a30e-80cc-439f-8bcd-9f2061a14547"
    },
    {
      "cell_type": "code",
      "source": [
        "# Linux操作系统，例如 云GPU平台：https://featurize.cn/?s=d7ce99f842414bfcaea5662a97581bd1\n",
        "# 如果遇到 SSL 相关报错，重新运行本代码块即可\n",
        "!wget https://zihao-openmmlab.obs.cn-east-3.myhuaweicloud.com/20220716-mmclassification/dataset/SimHei.ttf -O /environment/miniconda3/lib/python3.7/site-packages/matplotlib/mpl-data/fonts/ttf/SimHei.ttf\n",
        "!rm -rf /home/featurize/.cache/matplotlib\n",
        "\n",
        "import matplotlib\n",
        "matplotlib.rc(\"font\",family='SimHei') # 中文字体\n"
      ],
      "outputs": [
        {
          "output_type": "stream",
          "name": "stdout",
          "text": "/environment/miniconda3/lib/python3.7/site-packages/matplotlib/mpl-data/fonts/ttf/SimHei.ttf: No such file or directory\r\n"
        }
      ],
      "execution_count": 1,
      "metadata": {
        "gather": {
          "logged": 1674572653711
        }
      },
      "id": "31ee00e7-50a1-4b5f-8a49-2623f350b59f"
    },
    {
      "cell_type": "markdown",
      "source": [
        "## 导入pillow中文字体"
      ],
      "metadata": {},
      "id": "ccf101d3-d3fe-4685-9232-05ffb4b38ec6"
    },
    {
      "cell_type": "code",
      "source": [
        "from PIL import ImageFont, ImageDraw\n",
        "# 导入中文字体，指定字号\n",
        "font = ImageFont.truetype('SimHei.ttf', 32)"
      ],
      "outputs": [],
      "execution_count": 2,
      "metadata": {
        "gather": {
          "logged": 1674572655124
        }
      },
      "id": "41442956-98b9-4438-81db-4609c7b18b7a"
    },
    {
      "cell_type": "markdown",
      "source": [
        "## 导入工具包"
      ],
      "metadata": {
        "tags": []
      },
      "id": "b8353a13-df79-456d-bd86-4efbc31b6e7a"
    },
    {
      "cell_type": "code",
      "source": [
        "import os\n",
        "import time\n",
        "import shutil\n",
        "import tempfile\n",
        "from tqdm import tqdm\n",
        "\n",
        "import cv2\n",
        "from PIL import Image\n",
        "\n",
        "import numpy as np\n",
        "import pandas as pd\n",
        "import matplotlib.pyplot as plt\n",
        "%matplotlib inline\n",
        "plt.rcParams['axes.unicode_minus']=False  # 用来正常显示负号\n",
        "plt.rcParams['font.sans-serif']=['SimHei']  # 用来正常显示中文标签\n",
        "import gc\n",
        "\n",
        "import torch\n",
        "import torch.nn.functional as F\n",
        "from torchvision import models\n",
        "\n",
        "import mmcv\n",
        "\n",
        "# 有 GPU 就用 GPU，没有就用 CPU\n",
        "device = torch.device('cuda:0' if torch.cuda.is_available() else 'cpu')\n",
        "print('device:', device)"
      ],
      "outputs": [
        {
          "output_type": "stream",
          "name": "stdout",
          "text": "device: cuda:0\n"
        }
      ],
      "execution_count": 3,
      "metadata": {
        "gather": {
          "logged": 1674572668542
        }
      },
      "id": "2773900f-d618-4a10-aaf8-32021231e326"
    },
    {
      "cell_type": "code",
      "source": [
        "# 后端绘图，不显示，只保存\n",
        "import matplotlib\n",
        "matplotlib.use('Agg')"
      ],
      "outputs": [],
      "execution_count": 4,
      "metadata": {
        "gather": {
          "logged": 1674572670562
        }
      },
      "id": "7bbd1246-21ef-4890-9df7-0955f07d8fe8"
    },
    {
      "cell_type": "markdown",
      "source": [
        "## 载入类别"
      ],
      "metadata": {},
      "id": "816aa3d9-66d1-4031-8d1f-3c33e013d194"
    },
    {
      "cell_type": "code",
      "source": [
        "idx_to_labels = np.load('idx_to_labels.npy', allow_pickle=True).item()"
      ],
      "outputs": [],
      "execution_count": 5,
      "metadata": {
        "gather": {
          "logged": 1674572672767
        }
      },
      "id": "b11498f4-1ffc-49d6-94b9-ce25b7ffdab2"
    },
    {
      "cell_type": "markdown",
      "source": [
        "## 导入训练好的模型"
      ],
      "metadata": {},
      "id": "9835161e-9fb1-435c-8c57-21e19c59e93b"
    },
    {
      "cell_type": "code",
      "source": [
        "model = torch.load('checkpoints/fruit30_pytorch_20220814.pth')\n",
        "model = model.eval().to(device)"
      ],
      "outputs": [],
      "execution_count": 6,
      "metadata": {
        "gather": {
          "logged": 1674572677904
        }
      },
      "id": "763cf29f-a535-40a1-a604-a7788d2b630f"
    },
    {
      "cell_type": "markdown",
      "source": [
        "## 图像预处理"
      ],
      "metadata": {},
      "id": "bb86c3f8-1dde-45a7-852b-ebd2f1ff0e0d"
    },
    {
      "cell_type": "code",
      "source": [
        "from torchvision import transforms\n",
        "\n",
        "# 测试集图像预处理-RCTN：缩放裁剪、转 Tensor、归一化\n",
        "test_transform = transforms.Compose([transforms.Resize(256),\n",
        "                                     transforms.CenterCrop(224),\n",
        "                                     transforms.ToTensor(),\n",
        "                                     transforms.Normalize(\n",
        "                                         mean=[0.485, 0.456, 0.406], \n",
        "                                         std=[0.229, 0.224, 0.225])\n",
        "                                    ])"
      ],
      "outputs": [],
      "execution_count": 7,
      "metadata": {
        "gather": {
          "logged": 1674572679419
        }
      },
      "id": "0e465576-c34a-4d12-874b-55bcf27de443"
    },
    {
      "cell_type": "markdown",
      "source": [
        "## 图像分类预测函数（同上个教程）"
      ],
      "metadata": {},
      "id": "2eb43857-3d47-4bae-97ac-a0e458cf82c2"
    },
    {
      "cell_type": "code",
      "source": [
        "def pred_single_frame(img, n=5):\n",
        "    '''\n",
        "    输入摄像头画面bgr-array，输出前n个图像分类预测结果的图像bgr-array\n",
        "    '''\n",
        "    img_rgb = cv2.cvtColor(img, cv2.COLOR_BGR2RGB) # BGR 转 RGB\n",
        "    img_pil = Image.fromarray(img_rgb) # array 转 pil\n",
        "    input_img = test_transform(img_pil).unsqueeze(0).to(device) # 预处理\n",
        "    pred_logits = model(input_img) # 执行前向预测，得到所有类别的 logit 预测分数\n",
        "    pred_softmax = F.softmax(pred_logits, dim=1) # 对 logit 分数做 softmax 运算\n",
        "    \n",
        "    top_n = torch.topk(pred_softmax, n) # 取置信度最大的 n 个结果\n",
        "    pred_ids = top_n[1].cpu().detach().numpy().squeeze() # 解析出类别\n",
        "    confs = top_n[0].cpu().detach().numpy().squeeze() # 解析出置信度\n",
        "    \n",
        "    # 在图像上写字\n",
        "    draw = ImageDraw.Draw(img_pil)\n",
        "    # 在图像上写字\n",
        "    for i in range(len(confs)):\n",
        "        pred_class = idx_to_labels[pred_ids[i]]\n",
        "        text = '{:<15} {:>.3f}'.format(pred_class, confs[i])\n",
        "        # 文字坐标，中文字符串，字体，rgba颜色\n",
        "        draw.text((50, 100 + 50 * i), text, font=font, fill=(255, 0, 0, 1))\n",
        "        \n",
        "    img_bgr = cv2.cvtColor(np.array(img_pil), cv2.COLOR_RGB2BGR) # RGB转BGR\n",
        "        \n",
        "    return img_bgr, pred_softmax"
      ],
      "outputs": [],
      "execution_count": 8,
      "metadata": {
        "gather": {
          "logged": 1674572681482
        }
      },
      "id": "911460a8-dd8b-4468-9a25-b0c97b819b05"
    },
    {
      "cell_type": "markdown",
      "source": [
        "## 视频预测"
      ],
      "metadata": {},
      "id": "dfaebb30-7e8f-47e8-a508-78438a4d31b7"
    },
    {
      "cell_type": "markdown",
      "source": [
        "### 输入输出视频路径"
      ],
      "metadata": {},
      "id": "55344eb0-8516-48a5-9c64-a9dbbf861fbb"
    },
    {
      "cell_type": "code",
      "source": [
        "input_video = 'test_img/fruits_video.mp4'"
      ],
      "outputs": [],
      "execution_count": 9,
      "metadata": {
        "gather": {
          "logged": 1674572691689
        }
      },
      "id": "a0ae61f8-23ec-4f99-8951-ebc1522280b7"
    },
    {
      "cell_type": "markdown",
      "source": [
        "### 可视化方案一：原始图像+预测结果文字"
      ],
      "metadata": {},
      "id": "3841b860-72a0-473a-af17-77ee559c994d"
    },
    {
      "cell_type": "code",
      "source": [
        "# 创建临时文件夹，存放每帧结果\n",
        "temp_out_dir = time.strftime('%Y%m%d%H%M%S')\n",
        "os.mkdir(temp_out_dir)\n",
        "print('创建临时文件夹 {} 用于存放每帧预测结果'.format(temp_out_dir))"
      ],
      "outputs": [
        {
          "output_type": "stream",
          "name": "stdout",
          "text": "创建临时文件夹 20230124150831 用于存放每帧预测结果\n"
        }
      ],
      "execution_count": 10,
      "metadata": {
        "gather": {
          "logged": 1674572694795
        }
      },
      "id": "9d92a9e1-040d-4c4b-881d-f16053086db0"
    },
    {
      "cell_type": "code",
      "source": [
        "# 读入待预测视频\n",
        "imgs = mmcv.VideoReader(input_video)\n",
        "\n",
        "prog_bar = mmcv.ProgressBar(len(imgs))\n",
        "\n",
        "# 对视频逐帧处理\n",
        "for frame_id, img in enumerate(imgs):\n",
        "    \n",
        "    ## 处理单帧画面\n",
        "    img, pred_softmax = pred_single_frame(img, n=5)\n",
        "\n",
        "    # 将处理后的该帧画面图像文件，保存至 /tmp 目录下\n",
        "    cv2.imwrite(f'{temp_out_dir}/{frame_id:06d}.jpg', img)\n",
        "    \n",
        "    prog_bar.update() # 更新进度条\n",
        "\n",
        "# 把每一帧串成视频文件\n",
        "mmcv.frames2video(temp_out_dir, 'output/output_pred.mp4', fps=imgs.fps, fourcc='mp4v')\n",
        "\n",
        "shutil.rmtree(temp_out_dir) # 删除存放每帧画面的临时文件夹\n",
        "print('删除临时文件夹', temp_out_dir)"
      ],
      "outputs": [
        {
          "output_type": "stream",
          "name": "stdout",
          "text": "[>>>>>>>>>>>>>>>>>>>>>>>>>>>>>] 211/211, 11.0 task/s, elapsed: 19s, ETA:     0s[                                                  ] 0/211, elapsed: 0s, ETA:\n删除临时文件夹 20230124150831\n"
        }
      ],
      "execution_count": 11,
      "metadata": {
        "gather": {
          "logged": 1674572749039
        }
      },
      "id": "4b53cf47-d1eb-4b77-97bd-8ce01dc3cbc4"
    },
    {
      "cell_type": "markdown",
      "source": [
        "### 可视化方案二：原始图像+预测结果文字+各类别置信度柱状图"
      ],
      "metadata": {},
      "id": "c1dcc3e2-f1e3-4dab-941c-786050cbb64e"
    },
    {
      "cell_type": "code",
      "source": [
        "def pred_single_frame_bar(img):\n",
        "    '''\n",
        "    输入pred_single_frame函数输出的bgr-array，加柱状图，保存\n",
        "    '''\n",
        "    img = cv2.cvtColor(img, cv2.COLOR_BGR2RGB) # BGR 转 RGB\n",
        "    fig = plt.figure(figsize=(18,6))\n",
        "    # 绘制左图-视频图\n",
        "    ax1 = plt.subplot(1,2,1)\n",
        "    ax1.imshow(img)\n",
        "    ax1.axis('off')\n",
        "    # 绘制右图-柱状图\n",
        "    ax2 = plt.subplot(1,2,2)\n",
        "    x = idx_to_labels.values()\n",
        "    y = pred_softmax.cpu().detach().numpy()[0] * 100\n",
        "    ax2.bar(x, y, alpha=0.5, width=0.3, color='yellow', edgecolor='red', lw=3)\n",
        "    plt.xlabel('类别', fontsize=20)\n",
        "    plt.ylabel('置信度', fontsize=20)\n",
        "    ax2.tick_params(labelsize=16) # 坐标文字大小\n",
        "    plt.ylim([0, 100]) # y轴取值范围\n",
        "    plt.xlabel('类别',fontsize=25)\n",
        "    plt.ylabel('置信度',fontsize=25)\n",
        "    plt.title('图像分类预测结果', fontsize=30)\n",
        "    plt.xticks(rotation=90) # 横轴文字旋转\n",
        "    \n",
        "    plt.tight_layout()\n",
        "    fig.savefig(f'{temp_out_dir}/{frame_id:06d}.jpg')\n",
        "    # 释放内存\n",
        "    fig.clf()\n",
        "    plt.close()\n",
        "    gc.collect()"
      ],
      "outputs": [],
      "execution_count": 12,
      "metadata": {
        "gather": {
          "logged": 1674572765062
        }
      },
      "id": "5470598c-13c0-429b-811b-22f715950310"
    },
    {
      "cell_type": "code",
      "source": [
        "# 创建临时文件夹，存放每帧结果\n",
        "temp_out_dir = time.strftime('%Y%m%d%H%M%S')\n",
        "os.mkdir(temp_out_dir)\n",
        "print('创建临时文件夹 {} 用于存放每帧预测结果'.format(temp_out_dir))"
      ],
      "outputs": [
        {
          "output_type": "stream",
          "name": "stdout",
          "text": "创建临时文件夹 20230124150957 用于存放每帧预测结果\n"
        }
      ],
      "execution_count": 13,
      "metadata": {
        "gather": {
          "logged": 1674572768848
        }
      },
      "id": "41615496-7b29-4bf5-8e3e-3350767fa2ff"
    },
    {
      "cell_type": "code",
      "source": [
        "# 读入待预测视频\n",
        "imgs = mmcv.VideoReader(input_video)\n",
        "\n",
        "prog_bar = mmcv.ProgressBar(len(imgs))\n",
        "\n",
        "# 对视频逐帧处理\n",
        "for frame_id, img in enumerate(imgs):\n",
        "    \n",
        "    ## 处理单帧画面\n",
        "    img, pred_softmax = pred_single_frame(img, n=5)\n",
        "    img = pred_single_frame_bar(img)\n",
        "    \n",
        "    prog_bar.update() # 更新进度条\n",
        "\n",
        "# 把每一帧串成视频文件\n",
        "mmcv.frames2video(temp_out_dir, 'output/output_bar.mp4', fps=imgs.fps, fourcc='mp4v')\n",
        "\n",
        "shutil.rmtree(temp_out_dir) # 删除存放每帧画面的临时文件夹\n",
        "print('删除临时文件夹', temp_out_dir)"
      ],
      "outputs": [
        {
          "output_type": "stream",
          "name": "stderr",
          "text": "findfont: Font family ['SimHei'] not found. Falling back to DejaVu Sans.\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:214: RuntimeWarning: Glyph 21704 missing from current font.\n  font.set_text(s, 0.0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:214: RuntimeWarning: Glyph 23494 missing from current font.\n  font.set_text(s, 0.0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:214: RuntimeWarning: Glyph 29916 missing from current font.\n  font.set_text(s, 0.0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:214: RuntimeWarning: Glyph 22307 missing from current font.\n  font.set_text(s, 0.0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:214: RuntimeWarning: Glyph 22899 missing from current font.\n  font.set_text(s, 0.0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:214: RuntimeWarning: Glyph 26524 missing from current font.\n  font.set_text(s, 0.0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:214: RuntimeWarning: Glyph 23665 missing from current font.\n  font.set_text(s, 0.0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:214: RuntimeWarning: Glyph 31481 missing from current font.\n  font.set_text(s, 0.0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:214: RuntimeWarning: Glyph 26472 missing from current font.\n  font.set_text(s, 0.0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:214: RuntimeWarning: Glyph 26757 missing from current font.\n  font.set_text(s, 0.0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:214: RuntimeWarning: Glyph 26586 missing from current font.\n  font.set_text(s, 0.0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:214: RuntimeWarning: Glyph 23376 missing from current font.\n  font.set_text(s, 0.0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:214: RuntimeWarning: Glyph 26592 missing from current font.\n  font.set_text(s, 0.0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:214: RuntimeWarning: Glyph 27308 missing from current font.\n  font.set_text(s, 0.0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:214: RuntimeWarning: Glyph 26690 missing from current font.\n  font.set_text(s, 0.0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:214: RuntimeWarning: Glyph 22278 missing from current font.\n  font.set_text(s, 0.0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:214: RuntimeWarning: Glyph 26792 missing from current font.\n  font.set_text(s, 0.0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:214: RuntimeWarning: Glyph 26928 missing from current font.\n  font.set_text(s, 0.0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:214: RuntimeWarning: Glyph 27060 missing from current font.\n  font.set_text(s, 0.0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:214: RuntimeWarning: Glyph 33714 missing from current font.\n  font.set_text(s, 0.0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:214: RuntimeWarning: Glyph 28779 missing from current font.\n  font.set_text(s, 0.0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:214: RuntimeWarning: Glyph 40857 missing from current font.\n  font.set_text(s, 0.0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:214: RuntimeWarning: Glyph 29461 missing from current font.\n  font.set_text(s, 0.0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:214: RuntimeWarning: Glyph 29492 missing from current font.\n  font.set_text(s, 0.0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:214: RuntimeWarning: Glyph 26691 missing from current font.\n  font.set_text(s, 0.0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:214: RuntimeWarning: Glyph 30707 missing from current font.\n  font.set_text(s, 0.0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:214: RuntimeWarning: Glyph 30722 missing from current font.\n  font.set_text(s, 0.0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:214: RuntimeWarning: Glyph 31958 missing from current font.\n  font.set_text(s, 0.0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:214: RuntimeWarning: Glyph 27224 missing from current font.\n  font.set_text(s, 0.0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:214: RuntimeWarning: Glyph 32993 missing from current font.\n  font.set_text(s, 0.0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:214: RuntimeWarning: Glyph 33821 missing from current font.\n  font.set_text(s, 0.0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:214: RuntimeWarning: Glyph 21340 missing from current font.\n  font.set_text(s, 0.0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:214: RuntimeWarning: Glyph 33040 missing from current font.\n  font.set_text(s, 0.0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:214: RuntimeWarning: Glyph 27225 missing from current font.\n  font.set_text(s, 0.0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:214: RuntimeWarning: Glyph 33426 missing from current font.\n  font.set_text(s, 0.0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:214: RuntimeWarning: Glyph 33510 missing from current font.\n  font.set_text(s, 0.0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:214: RuntimeWarning: Glyph 33529 missing from current font.\n  font.set_text(s, 0.0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:214: RuntimeWarning: Glyph 32418 missing from current font.\n  font.set_text(s, 0.0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:214: RuntimeWarning: Glyph 38738 missing from current font.\n  font.set_text(s, 0.0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:214: RuntimeWarning: Glyph 33609 missing from current font.\n  font.set_text(s, 0.0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:214: RuntimeWarning: Glyph 33683 missing from current font.\n  font.set_text(s, 0.0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:214: RuntimeWarning: Glyph 33620 missing from current font.\n  font.set_text(s, 0.0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:214: RuntimeWarning: Glyph 26525 missing from current font.\n  font.set_text(s, 0.0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:214: RuntimeWarning: Glyph 33760 missing from current font.\n  font.set_text(s, 0.0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:214: RuntimeWarning: Glyph 33889 missing from current font.\n  font.set_text(s, 0.0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:214: RuntimeWarning: Glyph 33796 missing from current font.\n  font.set_text(s, 0.0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:214: RuntimeWarning: Glyph 30333 missing from current font.\n  font.set_text(s, 0.0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:214: RuntimeWarning: Glyph 35199 missing from current font.\n  font.set_text(s, 0.0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:214: RuntimeWarning: Glyph 26623 missing from current font.\n  font.set_text(s, 0.0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:214: RuntimeWarning: Glyph 36710 missing from current font.\n  font.set_text(s, 0.0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:214: RuntimeWarning: Glyph 21400 missing from current font.\n  font.set_text(s, 0.0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:214: RuntimeWarning: Glyph 39321 missing from current font.\n  font.set_text(s, 0.0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:214: RuntimeWarning: Glyph 34121 missing from current font.\n  font.set_text(s, 0.0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:214: RuntimeWarning: Glyph 40644 missing from current font.\n  font.set_text(s, 0.0, flags=flags)\nfindfont: Font family ['SimHei'] not found. Falling back to DejaVu Sans.\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:214: RuntimeWarning: Glyph 31867 missing from current font.\n  font.set_text(s, 0.0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:214: RuntimeWarning: Glyph 21035 missing from current font.\n  font.set_text(s, 0.0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:214: RuntimeWarning: Glyph 32622 missing from current font.\n  font.set_text(s, 0.0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:214: RuntimeWarning: Glyph 20449 missing from current font.\n  font.set_text(s, 0.0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:214: RuntimeWarning: Glyph 24230 missing from current font.\n  font.set_text(s, 0.0, flags=flags)\nfindfont: Font family ['SimHei'] not found. Falling back to DejaVu Sans.\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:214: RuntimeWarning: Glyph 22270 missing from current font.\n  font.set_text(s, 0.0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:214: RuntimeWarning: Glyph 20687 missing from current font.\n  font.set_text(s, 0.0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:214: RuntimeWarning: Glyph 20998 missing from current font.\n  font.set_text(s, 0.0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:214: RuntimeWarning: Glyph 39044 missing from current font.\n  font.set_text(s, 0.0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:214: RuntimeWarning: Glyph 27979 missing from current font.\n  font.set_text(s, 0.0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:214: RuntimeWarning: Glyph 32467 missing from current font.\n  font.set_text(s, 0.0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:183: RuntimeWarning: Glyph 21704 missing from current font.\n  font.set_text(s, 0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:183: RuntimeWarning: Glyph 23494 missing from current font.\n  font.set_text(s, 0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:183: RuntimeWarning: Glyph 29916 missing from current font.\n  font.set_text(s, 0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:183: RuntimeWarning: Glyph 22307 missing from current font.\n  font.set_text(s, 0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:183: RuntimeWarning: Glyph 22899 missing from current font.\n  font.set_text(s, 0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:183: RuntimeWarning: Glyph 26524 missing from current font.\n  font.set_text(s, 0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:183: RuntimeWarning: Glyph 23665 missing from current font.\n  font.set_text(s, 0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:183: RuntimeWarning: Glyph 31481 missing from current font.\n  font.set_text(s, 0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:183: RuntimeWarning: Glyph 26472 missing from current font.\n  font.set_text(s, 0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:183: RuntimeWarning: Glyph 26757 missing from current font.\n  font.set_text(s, 0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:183: RuntimeWarning: Glyph 26586 missing from current font.\n  font.set_text(s, 0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:183: RuntimeWarning: Glyph 23376 missing from current font.\n  font.set_text(s, 0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:183: RuntimeWarning: Glyph 26592 missing from current font.\n  font.set_text(s, 0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:183: RuntimeWarning: Glyph 27308 missing from current font.\n  font.set_text(s, 0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:183: RuntimeWarning: Glyph 26690 missing from current font.\n  font.set_text(s, 0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:183: RuntimeWarning: Glyph 22278 missing from current font.\n  font.set_text(s, 0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:183: RuntimeWarning: Glyph 26792 missing from current font.\n  font.set_text(s, 0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:183: RuntimeWarning: Glyph 26928 missing from current font.\n  font.set_text(s, 0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:183: RuntimeWarning: Glyph 27060 missing from current font.\n  font.set_text(s, 0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:183: RuntimeWarning: Glyph 33714 missing from current font.\n  font.set_text(s, 0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:183: RuntimeWarning: Glyph 28779 missing from current font.\n  font.set_text(s, 0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:183: RuntimeWarning: Glyph 40857 missing from current font.\n  font.set_text(s, 0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:183: RuntimeWarning: Glyph 29461 missing from current font.\n  font.set_text(s, 0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:183: RuntimeWarning: Glyph 29492 missing from current font.\n  font.set_text(s, 0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:183: RuntimeWarning: Glyph 26691 missing from current font.\n  font.set_text(s, 0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:183: RuntimeWarning: Glyph 30707 missing from current font.\n  font.set_text(s, 0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:183: RuntimeWarning: Glyph 30722 missing from current font.\n  font.set_text(s, 0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:183: RuntimeWarning: Glyph 31958 missing from current font.\n  font.set_text(s, 0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:183: RuntimeWarning: Glyph 27224 missing from current font.\n  font.set_text(s, 0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:183: RuntimeWarning: Glyph 32993 missing from current font.\n  font.set_text(s, 0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:183: RuntimeWarning: Glyph 33821 missing from current font.\n  font.set_text(s, 0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:183: RuntimeWarning: Glyph 21340 missing from current font.\n  font.set_text(s, 0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:183: RuntimeWarning: Glyph 33040 missing from current font.\n  font.set_text(s, 0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:183: RuntimeWarning: Glyph 27225 missing from current font.\n  font.set_text(s, 0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:183: RuntimeWarning: Glyph 33426 missing from current font.\n  font.set_text(s, 0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:183: RuntimeWarning: Glyph 33510 missing from current font.\n  font.set_text(s, 0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:183: RuntimeWarning: Glyph 33529 missing from current font.\n  font.set_text(s, 0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:183: RuntimeWarning: Glyph 32418 missing from current font.\n  font.set_text(s, 0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:183: RuntimeWarning: Glyph 38738 missing from current font.\n  font.set_text(s, 0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:183: RuntimeWarning: Glyph 33609 missing from current font.\n  font.set_text(s, 0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:183: RuntimeWarning: Glyph 33683 missing from current font.\n  font.set_text(s, 0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:183: RuntimeWarning: Glyph 33620 missing from current font.\n  font.set_text(s, 0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:183: RuntimeWarning: Glyph 26525 missing from current font.\n  font.set_text(s, 0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:183: RuntimeWarning: Glyph 33760 missing from current font.\n  font.set_text(s, 0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:183: RuntimeWarning: Glyph 33889 missing from current font.\n  font.set_text(s, 0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:183: RuntimeWarning: Glyph 33796 missing from current font.\n  font.set_text(s, 0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:183: RuntimeWarning: Glyph 30333 missing from current font.\n  font.set_text(s, 0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:183: RuntimeWarning: Glyph 35199 missing from current font.\n  font.set_text(s, 0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:183: RuntimeWarning: Glyph 26623 missing from current font.\n  font.set_text(s, 0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:183: RuntimeWarning: Glyph 36710 missing from current font.\n  font.set_text(s, 0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:183: RuntimeWarning: Glyph 21400 missing from current font.\n  font.set_text(s, 0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:183: RuntimeWarning: Glyph 39321 missing from current font.\n  font.set_text(s, 0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:183: RuntimeWarning: Glyph 34121 missing from current font.\n  font.set_text(s, 0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:183: RuntimeWarning: Glyph 40644 missing from current font.\n  font.set_text(s, 0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:183: RuntimeWarning: Glyph 31867 missing from current font.\n  font.set_text(s, 0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:183: RuntimeWarning: Glyph 21035 missing from current font.\n  font.set_text(s, 0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:183: RuntimeWarning: Glyph 32622 missing from current font.\n  font.set_text(s, 0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:183: RuntimeWarning: Glyph 20449 missing from current font.\n  font.set_text(s, 0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:183: RuntimeWarning: Glyph 24230 missing from current font.\n  font.set_text(s, 0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:183: RuntimeWarning: Glyph 22270 missing from current font.\n  font.set_text(s, 0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:183: RuntimeWarning: Glyph 20687 missing from current font.\n  font.set_text(s, 0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:183: RuntimeWarning: Glyph 20998 missing from current font.\n  font.set_text(s, 0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:183: RuntimeWarning: Glyph 39044 missing from current font.\n  font.set_text(s, 0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:183: RuntimeWarning: Glyph 27979 missing from current font.\n  font.set_text(s, 0, flags=flags)\n/anaconda/envs/azureml_py38/lib/python3.8/site-packages/matplotlib/backends/backend_agg.py:183: RuntimeWarning: Glyph 32467 missing from current font.\n  font.set_text(s, 0, flags=flags)\n"
        },
        {
          "output_type": "stream",
          "name": "stdout",
          "text": "[>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>] 211/211, 23.6 task/s, elapsed: 9s, ETA:     0s[                                                  ] 0/211, elapsed: 0s, ETA:\n删除临时文件夹 20230124150957\n"
        }
      ],
      "execution_count": 14,
      "metadata": {
        "gather": {
          "logged": 1674572901091
        }
      },
      "id": "4a4ac4a1-b44c-4028-8e11-7ad24a0bff55"
    },
    {
      "cell_type": "code",
      "source": [],
      "outputs": [],
      "execution_count": null,
      "metadata": {},
      "id": "75a7c2bb-a2c3-4026-b858-be8b18cd0b81"
    }
  ],
  "metadata": {
    "kernelspec": {
      "name": "python3",
      "language": "python",
      "display_name": "Python 3 (ipykernel)"
    },
    "language_info": {
      "name": "python",
      "version": "3.8.5",
      "mimetype": "text/x-python",
      "codemirror_mode": {
        "name": "ipython",
        "version": 3
      },
      "pygments_lexer": "ipython3",
      "nbconvert_exporter": "python",
      "file_extension": ".py"
    },
    "kernel_info": {
      "name": "python3"
    },
    "microsoft": {
      "host": {
        "AzureML": {
          "notebookHasBeenCompleted": true
        }
      }
    },
    "nteract": {
      "version": "nteract-front-end@1.0.0"
    }
  },
  "nbformat": 4,
  "nbformat_minor": 5
}